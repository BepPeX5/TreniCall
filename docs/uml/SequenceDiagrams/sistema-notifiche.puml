@startuml
!theme plain
title TreniCal - Sequence Diagram: Sistema Notifiche Real-time

actor Cliente as C
participant "Client GUI" as GUI
participant "gRPC Client" as GC
participant "NotificaServiceImpl" as NSI
participant "Admin Console" as ADMIN
participant "File System" as FS
participant "StreamObserver" as SO

== Connessione Client per Notifiche ==
C -> GUI: Clicca tab "Gestione Notifiche"
GUI -> GUI: addFollowTrainTab()
C -> GUI: Clicca "Carica Treni"
GUI -> GC: listaTreniAttivi()
GC -> NSI: listaTreniAttivi(Empty)
NSI -> "TrenoRepository": findAll()
"TrenoRepository" --> NSI: List<Treno>
NSI --> GC: ListaTreniResponse
GC --> GUI: Popola ComboBox treni

C -> GUI: Seleziona treno e clicca "Attiva Notifiche"
GUI -> GC: seguiTreno(clienteId, trenoCodice, streamObserver)

== Registrazione Stream Notifiche ==
GC -> NSI: seguiTreno(request, responseObserver)
NSI -> NSI: globalSubscribers.put(clienteId, responseObserver)
NSI -> NSI: subscribersByTrain.get(codice).add(responseObserver)
NSI -> SO: onNext(ack: "Registrato per treno + notifiche admin")
SO --> GUI: Mostra "Ora stai seguendo il treno..."

GUI -> GC: seguiTreno(clienteId, "", streamObserver) // Notifiche globali
GC -> NSI: seguiTreno(request, responseObserver)
NSI -> NSI: globalSubscribers.put(clienteId, responseObserver)

== Notifiche Automatiche (ogni 45 secondi) ==
loop Ogni 45 secondi
    NSI -> NSI: pushSimulatedUpdates() [@Scheduled]

    par Notifiche Treni Seguiti
        NSI -> NSI: pushNotifichetreniSeguiti()
        loop Per ogni treno seguito
            NSI -> NSI: randomUpdateMessage(codice)
            NSI -> SO: onNext("[TRENI SEGUITI] Treno X: in orario")
            SO --> GUI: Appare in notificheArea
        end
    and Notifiche Treni Acquistati
        NSI -> NSI: pushNotificheTreniAcquistati()
        NSI -> "BigliettoRepository": findAll()
        NSI -> NSI: getTreniConBiglietti(clienteId)
        loop Per ogni cliente con biglietti
            NSI -> SO: onNext("[TRENI ACQUISTATI] Treno Y: arrivo previsto...")
            SO --> GUI: Appare in notificheArea
        end
    end
end

== Notifiche Admin (ogni secondo) ==
loop Ogni secondo
    NSI -> NSI: checkAdminNotifications() [@Scheduled]
    NSI -> FS: readAllLines(NOTIFICATIONS_FILE)

    alt File contiene notifiche
        FS --> NSI: List<String> notifiche
        loop Per ogni riga notifica
            NSI -> NSI: processAdminNotification(line)
            alt Notifica per treno specifico
                NSI -> NSI: inviaNotificaAdminATreno(trainId, eventType, message)
                NSI -> SO: onNext("[ADMIN-ALERT] Treno X: ritardo 15 minuti")
                SO --> GUI: Appare notifica admin in tempo reale
            else Broadcast globale
                NSI -> NSI: inviaNotificaBroadcastGlobale(message, eventType)
                loop Per tutti i client connessi
                    NSI -> SO: onNext("[BROADCAST] Servizio interrotto linea Nord")
                    SO --> GUI: Appare broadcast globale
                end
            end
        end
        NSI -> FS: truncate(NOTIFICATIONS_FILE) // Pulisce file
    else File vuoto
        FS --> NSI: Empty
    end
end

== Invio da Admin Console ==
ADMIN -> FS: write("TR001|RITARDO|Ritardo di 15 minuti causa maltempo")
FS --> ADMIN: File scritto
note right
    Formato: TRENO_ID|EVENTO|MESSAGGIO
    o BROADCAST|EVENTO|MESSAGGIO
end note

== Notifiche Scadenza Prenotazioni ==
loop Ogni minuto
    "PrenotazioneService" -> "PrenotazioneService": verificaScadenzeImminenti() [@Scheduled]
    "PrenotazioneService" -> NSI: inviaNotificaScadenza(clienteId, messaggio, trenoId)
    NSI -> SO: onNext("[SCADENZA-ALERT] Prenotazione scade tra 2 minuti")
    SO --> GUI: Notifica urgente scadenza
end

== Disconnessione Client ==
C -> GUI: Chiude applicazione
GUI -> GC: logoutNotifiche(clienteId)
GC -> NSI: logoutNotifiche(request)
NSI -> NSI: globalSubscribers.remove(clienteId)
NSI -> NSI: subscribersByTrain.removeIf(observer == removed)
NSI --> GC: LogoutResponse(success=true)

@enduml

